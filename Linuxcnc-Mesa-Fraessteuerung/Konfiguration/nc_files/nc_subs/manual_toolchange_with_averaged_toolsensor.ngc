o<manual_toolchange_with_averaged_toolsensor> sub


;*********** Commanded Data ******************
;Backup of commanded Toolnumber and Pocket
;otherwise after the M6 this information is gone!

#<tool> = #<_selected_tool>
#<pocket> = #<_selected_pocket>
;(debug, #<_selected_tool>)
;(debug, #<_selected_pocket>)
;*********************************************


;************ Milltask verifiy ***************
; we must execute this only in the milltask interpreter
; or preview will break, so test for '#<_task>' which is 1 for 
; the milltask interpreter and 0 in the UI's
O100 if [#<_task> EQ 0]
        (debug, Task ist Null)
O100     return [999]
O100 endif

;*********************************************


;**** Approaching Tool Change Location *******
;Move to Position defined in ini File

;first move Spindle up
G53 G0 Z[#<_ini[AXIS_2]MAX_LIMIT>-0.1]
; then Planar move to change position
G53 G0 X[#<_ini[CHANGE_POSITION]X>] Y[#<_ini[CHANGE_POSITION]Y>]
G53 G0 Z[#<_ini[CHANGE_POSITION]Z>]

;*********************************************


;******* Check for nessecity of toolchange ***
o200 if [#<_current_tool> EQ #<_selected_tool>]
(debug, Tool already in Spindle)
o200 else 
;*********************************************


;*** Stop Spindle and call regular M6 Dialog *
M5

G49

M6 T#<_selected_tool>
;*********************************************

;**** Check for unplausible Parameters ********

O300 if [#<_hal[probe.use_toolmeasurement]> EQ 0]
O300 return [3] ; indicate no tool measurement 
O300 endif

G53 G0 X[#<_ini[TOOLSENSOR]X>] Y[#<_ini[TOOLSENSOR]Y>]
G53 G0 Z[#<_ini[TOOLSENSOR]Z>]

O400 if [#<_hal[probe.ps_searchvel]> LE 0]
O400 return [-1] ; indicate searchvel <= 0 
O400 endif

O500 if [#<_hal[probe.ps_probevel]> LE 0]
O500 return [-2] ; indicate probevel <= 0 
O500 endif

;**********************************************

;#1900=#<_coord_system>	(NP merken nur G54 bis G59)

;G54
;G90 G0 	

;G43.1 Z0	   	 (TLO reset)
;G91


;*** Coarse Z Position measurement **********

F #<_hal[probe.ps_searchvel]>
G91
G38.2 Z #<_ini[TOOLSENSOR]MAXPROBE>
G1 Z1.0
;********************************************


;*** Check for contact failure **************
O500 if [#5070 EQ 0]
G90
O500 return [-3] ; indicate probe contact failure to epilog
O500 endif

;********************************************

;*** Averaged fine length runs **************
;The sensor Trip point is passed multiple times in both directions
;in order to average out the hysteresis

#<Anzahl_Messungen> = 5
#<Durchlauf_Nummer> = 1

G38.2 Z-65  F500   	 (messen grob)
G1    Z1.0  F250   	 (frei fahren)	
(debug, Grobkontakt hergestellt)

(debug, Beginn Feinmesszyklus)

o110 while [#<Durchlauf_Nummer> LE  #<Anzahl_Messungen>]

;(debug, Accurate Movement #<Durchlauf_Nummer>)

#<Durchlauf_Nummer> = [#<Durchlauf_Nummer> + 1]

G38.2 Z-2.0  F25    	 (messen fein)
(debug,Ausloesewert #5063)

#2004 = [#2004 + #5063]

;(debug,Stand Sammelvariable #2004)

G38.4 Z2.0 F25
(debug,Ausloesewert #5063)

G1 Z1.0 F250

#2004 = [#2004 + #5063]

;(debug,Stand Sammelvariable #2004)


o110 endwhile

(debug, Feinmesszyklus durchgefuehrt)

;Neuen Werkzeugoffset berechnen

#2005=[#2004/[#<Anzahl_Messungen> * 2]]

(debug,Mittelwert Ausloesewerte #2005)

#2000=[#2005+#5223]	 (Tastpunkt+NP Verschiebung)
(debug,Tastpunkt+NP Verschiebung #2000)
(debug, NP Verschiebung #5223)

#2011=[#2000-#2002] 
(debug,Deltawert alt zu neu #2011)

;#2001=[#2000-#2002+#2003](Neu - diff + alt)  
#2002=[#2000]      	 (Tastpunkt+NP Verschiebung alt merken)
#2003=[#2011]	   	 (Delta alt merken)


#2010 = -125

o600 if [#2011 LT #2010]
#2011 = 0
(debug,Erstes Werkzeug ? )
(debug, LÃ¤ngenoffset auf 0 gesetzt !)
(debug, Hinterlegter Tastpunkt+NP Verschiebung #2002)
o600 endif






#2004 = 0            (Sammelvariable zuruecksetzen)

G1 Z5.0 F500       	 (frei fahren)
G90 G0

;Neuen Werkzeugoffset setzen

;G43.1 Z#2001       	 (TLO set)
G43.1 Z#2011       	 (TLO set)
G10 L1 P#<_selected_tool> Z#2000    (Einlesen des Korrekturwertes in Z in die Werkzeugtabelle) 
G53 Z#1800		 (Sichere Z Position)
G53 Z#1702	   	 (Wechsel Z Position)

o601 if [#2011 LT #2010 AND #2011 GT 0]
(debug, Differenz Werkzeuglaengen ist: #2011)
o601 endif

(NP wiederhestellen nur G54 bis G59)	
o100 if[#1900 EQ 540]
G54
o100 endif
o101 if[#1900 EQ 550]
G55
o101 endif
o102 if[#1900 EQ 560]
G56
o102 endif
o103 if[#1900 EQ 570]
G57
o103 endif
o104 if[#1900 EQ 580]
G58
o104 endif

o500 endif


o<messen_werkzeuglaenge> endsub
M2

