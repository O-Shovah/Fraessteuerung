o<messen_werkzeuglaenge> sub
#1700=50		(Wechsel X Position)
#1701=50		(Wechsel Y Position)
#1702=-5		(Wechsel Z Position)

#1800=-100		(Position sicheres Z)
#1801=3 		(Position Taster X)
#1802=52.3		(Position Taster Y)

#1900=#<_coord_system>	(NP merken nur G54 bis G59)

o500 if [#<_current_tool> EQ #<_selected_tool>]
(debug, Tool bereits in der Spindel)
o500 else 
M5
G54
G90 G0 	

G53 Z#1702	   	 (Wechsel Z Position)
G53 X#1700 Y#1701   	 (Wechsel XY Position)
M6 T#<_selected_tool>

G53 X#1801 Y#1802  	 (Taster Position)
G53 Z#1800	   	 (Sichere Z Position)

G43.1 Z0	   	 (TLO reset)
G91

;Mehrfache Messlaeufe in beide Ausloeserichtungen des Schalters um Hysterese auszugleichen.



#<Anzahl_Messungen> = 5
#<Durchlauf_Nummer> = 1

G38.2 Z-65  F500   	 (messen grob)
G1    Z1.0  F250   	 (frei fahren)	
(debug, Grobkontakt hergestellt)

(debug, Beginn Feinmesszyklus)

o110 while [#<Durchlauf_Nummer> LE  #<Anzahl_Messungen>]

;(debug, Feinmessdurchlauf #<Durchlauf_Nummer>)

#<Durchlauf_Nummer> = [#<Durchlauf_Nummer> + 1]

G38.2 Z-2.0  F25    	 (messen fein)
(debug,Ausloesewert #5063)

#2004 = [#2004 + #5063]

;(debug,Stand Sammelvariable #2004)

G38.4 Z2.0 F25
(debug,Ausloesewert #5063)

G1 Z1.0 F250

#2004 = [#2004 + #5063]

;(debug,Stand Sammelvariable #2004)


o110 endwhile

(debug, Feinmesszyklus durchgefuehrt)

;Neuen Werkzeugoffset berechnen

#2005=[#2004/[#<Anzahl_Messungen> * 2]]

(debug,Mittelwert Ausloesewerte #2005)

#2000=[#2005+#5223]	 (Tastpunkt+NP Verschiebung)
(debug,Tastpunkt+NP Verschiebung #2000)
(debug, NP Verschiebung #5223)

#2011=[#2000-#2002] 
(debug,Deltawert alt zu neu #2011)

;#2001=[#2000-#2002+#2003](Neu - diff + alt)  
#2002=[#2000]      	 (Tastpunkt+NP Verschiebung alt merken)
#2003=[#2011]	   	 (Delta alt merken)


#2010 = -125

o600 if [#2011 LT #2010]
#2011 = 0
(debug,Erstes Werkzeug ? )
(debug, LÃ¤ngenoffset auf 0 gesetzt !)
(debug, Hinterlegter Tastpunkt+NP Verschiebung #2002)
o600 endif






#2004 = 0            (Sammelvariable zuruecksetzen)

G1 Z5.0 F500       	 (frei fahren)
G90 G0

;Neuen Werkzeugoffset setzen

;G43.1 Z#2001       	 (TLO set)
G43.1 Z#2011       	 (TLO set)
G10 L1 P#<_selected_tool> Z#2000    (Einlesen des Korrekturwertes in Z in die Werkzeugtabelle) 
G53 Z#1800		 (Sichere Z Position)
G53 Z#1702	   	 (Wechsel Z Position)

o601 if [#2011 LT #2010 AND #2011 GT 0]
(debug, Differenz Werkzeuglaengen ist: #2011)
o601 endif

(NP wiederhestellen nur G54 bis G59)	
o100 if[#1900 EQ 540]
G54
o100 endif
o101 if[#1900 EQ 550]
G55
o101 endif
o102 if[#1900 EQ 560]
G56
o102 endif
o103 if[#1900 EQ 570]
G57
o103 endif
o104 if[#1900 EQ 580]
G58
o104 endif

o500 endif


o<messen_werkzeuglaenge> endsub
M2

